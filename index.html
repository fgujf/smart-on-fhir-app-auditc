<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alcohol Assessment - AUDIT C (SMART-enabled)</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; }
    .section { padding:15px; margin-bottom:10px; border-radius:5px; }
    .section-1 { background-color:#e6f7ff; }
    .section-2 { background-color:#fffbe6; }
    label { display:block; margin-top:10px; font-weight:bold; }
    select { width:100%; padding:5px; margin-top:5px; }
    .result, .score-output { margin-top:10px; font-weight:bold; }
    .risk-low { background:#e6f9ed; color:#28a745; padding:5px 10px; border-radius:4px; }
    .risk-increasing { background:#fff9db; color:#ffc107; padding:5px 10px; border-radius:4px; }
    .risk-higher { background:#fff3e0; color:#ff9800; padding:5px 10px; border-radius:4px; }
    .risk-dependence { background:#fdecea; color:#dc3545; padding:5px 10px; border-radius:4px; }
    button { margin-top:10px; padding:8px 12px; }
    .disabled-section { opacity:0.6; pointer-events:none; }
    .small-select { width:200px; padding:5px; margin-top:5px; }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

<div id="contextBanner" style="background:#f0f0f0;padding:8px;margin-bottom:15px;border-radius:5px;">
  Loading patient and provider info...
</div>

<script>
  // SMART Context
  FHIR.oauth2.ready().then(async client => {
    window.smartClient = client;
    let banner = "";

    if (client.patient && client.patient.id) {
      try {
        const patient = await client.patient.read();
        const name = (patient.name?.[0]?.given?.join(" ") || "") + " " + (patient.name?.[0]?.family || "");
        banner += `<b>Patient:</b> ${name} | <b>Gender:</b> ${patient.gender || "Unknown"} | <b>DOB:</b> ${patient.birthDate || "Unknown"}`;
        document.getElementById('saveToEHRBtn').disabled = false;
      } catch {
        banner += "<b>Patient:</b> Unknown";
      }
    } else {
      banner += "<b>Patient:</b> No context";
    }

    try {
      const user = await client.user.read();
      const username = (user.name?.[0]?.given?.[0] || "") + " " + (user.name?.[0]?.family || "");
      banner += `<br><b>User:</b> ${username || user.id || "Unknown"} (${user.resourceType})`;
    } catch {
      banner += "<br><b>User:</b> Unknown";
    }

    document.getElementById("contextBanner").innerHTML = banner;
  }).catch(err => {
    console.error("SMART flow failed:", err);
    document.getElementById("contextBanner").textContent = "Failed to load context.";
  });
</script>

<h1>Alcohol Assessment – AUDIT C</h1>

<form id="auditForm">
  <label>
    Gender: *
    <select id="gender" class="small-select" required>
      <option value="" disabled selected>Choose...</option>
      <option value="male">Male</option>
      <option value="female">Female</option>
      <option value="other">Other / Prefer not to say</option>
    </select>
  </label>

  <div class="section section-1">
    <h2>Section 1 (Questions 1–3)</h2>
    <label>
      1. How often do you have a drink containing alcohol? *
      <select id="q1" required>
        <option value="" disabled selected>Choose...</option>
        <option value="0">Never (0)</option>
        <option value="1">Monthly or less (1)</option>
        <option value="2">2–4 times per month (2)</option>
        <option value="3">2–3 times per week (3)</option>
        <option value="4">4 or more times per week (4)</option>
      </select>
    </label>
    <label>
      2. How many units do you drink on a typical drinking day? *
      <select id="q2" required>
        <option value="" disabled selected>Choose...</option>
        <option value="0">0–2 units (0)</option>
        <option value="1">3–4 units (1)</option>
        <option value="2">5–6 units (2)</option>
        <option value="3">7–9 units (3)</option>
        <option value="4">10 or more units (4)</option>
      </select>
    </label>
    <label>
      3. How often have you had 6+ (F) / 8+ (M) units on one occasion in the past year? *
      <select id="q3" required>
        <option value="" disabled selected>Choose...</option>
        <option value="0">Never (0)</option>
        <option value="1">Less than monthly (1)</option>
        <option value="2">Monthly (2)</option>
        <option value="3">Weekly (3)</option>
        <option value="4">Daily or almost daily (4)</option>
      </select>
    </label>

    <button type="button" onclick="calculateFastC()">Calculate FAST C Score</button>
    <div id="fastCScore" class="score-output">FAST C Score: —</div>
  </div>

  <div id="section2" class="section section-2 disabled-section">
    <h2>Section 2 (Questions 4–10)</h2>
      <!-- (all your section 2 select elements are preserved exactly) -->
      <label>
        4. How often during the last year have you found you couldn’t stop drinking once started? *
        <select id="q4" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        5. How often in the last year did drinking prevent doing what was expected? *
        <select id="q5" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        6. How often in the last year did you need a drink in the morning after heavy drinking? *
        <select id="q6" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        7. How often in the last year have you felt guilt or remorse after drinking? *
        <select id="q7" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        8. How often in the last year were you unable to remember what happened the night before? *
        <select id="q8" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        9. Have you or someone else been injured due to your drinking? *
        <select id="q9" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">No (0)</option>
          <option value="2">Yes, but not in last year (2)</option>
          <option value="4">Yes, during the last year (4)</option>
        </select>
      </label>
      <label>
        10. Has a relative, friend, doctor, or health worker been concerned or suggested you cut down? *
        <select id="q10" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">No (0)</option>
          <option value="2">Yes, but not in last year (2)</option>
          <option value="4">Yes, during the last year (4)</option>
        </select>
      </label>

      <button type="button" onclick="calculateAuditScore()">Calculate Total Audit Score</button>
    <div id="totalAuditScore" class="score-output">Total Audit Score: —</div>
    <div id="riskSeverity" class="result"></div>

    <button id="saveToEHRBtn" type="button" onclick="saveToEHR()" disabled>
      Save answers to EHR (QuestionnaireResponse)
    </button>
  </div>
</form>

<script>
  // --- Scoring functions ---
  function calculateFastC() {
    const gender = document.getElementById('gender').value;
    const q1 = parseInt(document.getElementById('q1').value || 0);
    const q2 = parseInt(document.getElementById('q2').value || 0);
    const q3 = parseInt(document.getElementById('q3').value || 0);

    if (!gender || isNaN(q1) || isNaN(q2) || isNaN(q3)) {
      alert("Please answer gender and all questions in Section 1.");
      return;
    }

    const fastCScore = q1 + q2 + q3;
    document.getElementById('fastCScore').textContent = `FAST C Score: ${fastCScore}`;

    const section2 = document.getElementById('section2');
    const selects = section2.querySelectorAll('select');
    const threshold = (gender === 'female') ? 3 : 4;

    if (fastCScore >= threshold) {
      section2.classList.remove('disabled-section');
      selects.forEach(select => select.disabled = false);
    } else {
      section2.classList.add('disabled-section');
      selects.forEach(select => {
        select.disabled = true;
        select.selectedIndex = 0;
      });
      document.getElementById('totalAuditScore').textContent = "Total Audit Score: —";
      document.getElementById('riskSeverity').textContent = "";
      document.getElementById('riskSeverity').className = "result";
    }
  }

  function calculateAuditScore() {
    const ids = ['q1','q2','q3','q4','q5','q6','q7','q8','q9','q10'];
    let total = 0;
    for (let id of ids) {
      const val = parseInt(document.getElementById(id).value);
      if (isNaN(val)) {
        alert("Please answer all questions before calculating the score.");
        return;
      }
      total += val;
    }
    document.getElementById('totalAuditScore').textContent = `Total Audit Score: ${total}`;

    const risk = document.getElementById('riskSeverity');
    risk.className = "result";
    if (total <= 7) { risk.textContent = "Risk Level: Low Risk"; risk.classList.add("risk-low"); }
    else if (total <= 15) { risk.textContent = "Risk Level: Increasing Risk"; risk.classList.add("risk-increasing"); }
    else if (total <= 19) { risk.textContent = "Risk Level: Higher Risk"; risk.classList.add("risk-higher"); }
    else { risk.textContent = "Risk Level: Possible Dependence"; risk.classList.add("risk-dependence"); }
  }

  async function saveToEHR() {
  if (!window.smartClient) {
    alert("App not authorized. Launch this app from an EHR (or use the SMART sandbox).");
    return;
  }
  const client = window.smartClient;

  if (!client.patient || !client.patient.id) {
    alert("No patient context available. App must be launched from EHR with a patient selected.");
    return;
  }

  // Get Q1–Q3
  const q1 = parseInt(document.getElementById('q1').value);
  const q2 = parseInt(document.getElementById('q2').value);
  const q3 = parseInt(document.getElementById('q3').value);

  if (isNaN(q1) || isNaN(q2) || isNaN(q3)) {
    alert("Please answer Q1–Q3 before saving.");
    return;
  }

  const auditCScore = q1 + q2 + q3;

  // --- QuestionnaireResponse with only Q1–Q3 ---
  const qr = {
    resourceType: "QuestionnaireResponse",
    //questionnaire: "http://loinc.org/72109-2", // AUDIT-C Panel
    status: "completed",
    subject: { reference: `Patient/${client.patient.id}` },
    authored: new Date().toISOString(),
    item: [
      {
        linkId: "1",
        text: "How often do you have a drink containing alcohol?",
        answer: [{ valueInteger: q1 }]
      },
      {
        linkId: "2",
        text: "How many standard drinks containing alcohol do you have on a typical day?",
        answer: [{ valueInteger: q2 }]
      },
      {
        linkId: "3",
        text: "How often do you have 6 or more drinks on 1 occasion?",
        answer: [{ valueInteger: q3 }]
      }
    ]
  };

  try {
    const createdQR = await client.create(qr);

    // --- Observation Q1 ---
    const obsQ1 = {
      resourceType: "Observation",
      status: "final",
      category: [{ coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "survey" }] }],
      code: { coding: [{ system: "http://loinc.org", code: "68518-0", display: "How often do you have a drink containing alcohol?" }] },
      subject: { reference: `Patient/${client.patient.id}` },
      effectiveDateTime: new Date().toISOString(),
      valueInteger: q1,
      derivedFrom: [{ reference: `QuestionnaireResponse/${createdQR.id}` }]
    };

    // --- Observation Q2 ---
    const obsQ2 = {
      resourceType: "Observation",
      status: "final",
      category: [{ coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "survey" }] }],
      code: { coding: [{ system: "http://loinc.org", code: "68519-8", display: "How many standard drinks containing alcohol do you have on a typical day?" }] },
      subject: { reference: `Patient/${client.patient.id}` },
      effectiveDateTime: new Date().toISOString(),
      valueInteger: q2,
      derivedFrom: [{ reference: `QuestionnaireResponse/${createdQR.id}` }]
    };

    // --- Observation Q3 ---
    const obsQ3 = {
      resourceType: "Observation",
      status: "final",
      category: [{ coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "survey" }] }],
      code: { coding: [{ system: "http://loinc.org", code: "68520-6", display: "How often do you have 6 or more drinks on 1 occasion?" }] },
      subject: { reference: `Patient/${client.patient.id}` },
      effectiveDateTime: new Date().toISOString(),
      valueInteger: q3,
      derivedFrom: [{ reference: `QuestionnaireResponse/${createdQR.id}` }]
    };

    // --- Observation: AUDIT-C total (Q1–Q3) ---
    const obsAuditC = {
      resourceType: "Observation",
      status: "final",
      category: [{ coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "survey" }] }],
      code: { coding: [{ system: "http://loinc.org", code: "75626-2", display: "Total score [AUDIT-C]" }] },
      subject: { reference: `Patient/${client.patient.id}` },
      effectiveDateTime: new Date().toISOString(),
      valueInteger: auditCScore,
      derivedFrom: [{ reference: `QuestionnaireResponse/${createdQR.id}` }]
    };

    // Save all Observations
    const [createdObsQ1, createdObsQ2, createdObsQ3, createdObsAuditC] = await Promise.all([
      client.create(obsQ1),
      client.create(obsQ2),
      client.create(obsQ3),
      client.create(obsAuditC)
    ]);

    alert(`Saved to EHR:
- QuestionnaireResponse id: ${createdQR.id}
- Q1 (68518-0) = ${q1}
- Q2 (68519-8) = ${q2}
- Q3 (68520-6) = ${q3}
- AUDIT-C Score (75626-2) = ${auditCScore}`);

  } catch (err) {
    console.error("Failed to save resources:", err);
    alert("Save to EHR failed (see console).");
  }
}
  window.calculateFastC = calculateFastC;
  window.calculateAuditScore = calculateAuditScore;
  window.saveToEHR = saveToEHR;
  </script>
</body>
</html>






