<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Alcohol Assessment - AUDIT C (SMART-enabled)</title>
  <style>
    /* (kept the same styles from your AuditC.html) */
    body { font-family: Arial, sans-serif; margin:20px; }
    .section { padding:15px; margin-bottom:10px; border-radius:5px; }
    .section-1 { background-color:#e6f7ff; }
    .section-2 { background-color:#fffbe6; }
    label { display:block; margin-top:10px; font-weight:bold; }
    select { width:100%; padding:5px; margin-top:5px; }
    .result, .score-output { margin-top:10px; font-weight:bold; }
    .risk-low { background:#e6f9ed; color:#28a745; padding:5px 10px; border-radius:4px; }
    .risk-increasing { background:#fff9db; color:#ffc107; padding:5px 10px; border-radius:4px; }
    .risk-higher { background:#fff3e0; color:#ff9800; padding:5px 10px; border-radius:4px; }
    .risk-dependence { background:#fdecea; color:#dc3545; padding:5px 10px; border-radius:4px; }
    button { margin-top:10px; padding:8px 12px; }
    .disabled-section { opacity:0.6; pointer-events:none; }
    .small-select { width:200px; padding:5px; margin-top:5px; }
  </style>
</head>
<body>

  <h1>Alcohol Assessment – AUDIT C</h1>
  <!-- SMART client -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

  <form id="auditForm">
    <label>
      Gender: *
      <select id="gender" class="small-select" required>
        <option value="" disabled selected>Choose...</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other / Prefer not to say</option>
      </select>
    </label>
    <div class="section section-1">
      <h2>Section 1 (Questions 1–3)</h2>
      <label>
        1. How often do you have a drink containing alcohol? *
        <select id="q1" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Monthly or less (1)</option>
          <option value="2">2–4 times per month (2)</option>
          <option value="3">2–3 times per week (3)</option>
          <option value="4">4 or more times per week (4)</option>
        </select>
      </label>
      <label>
        2. How many units do you drink on a typical drinking day? *
        <select id="q2" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">0–2 units (0)</option>
          <option value="1">3–4 units (1)</option>
          <option value="2">5–6 units (2)</option>
          <option value="3">7–9 units (3)</option>
          <option value="4">10 or more units (4)</option>
        </select>
      </label>
      <label>
        3. How often have you had 6+ (F) / 8+ (M) units on one occasion in the past year? *
        <select id="q3" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>

      <button type="button" onclick="calculateFastC()">Calculate FAST C Score</button>
      <div id="fastCScore" class="score-output">FAST C Score: —</div>
    </div>

    <div id="section2" class="section section-2 disabled-section">
      <h2>Section 2 (Questions 4–10)</h2>
      <!-- (all your section 2 select elements are preserved exactly) -->
      <label>
        4. How often during the last year have you found you couldn’t stop drinking once started? *
        <select id="q4" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        5. How often in the last year did drinking prevent doing what was expected? *
        <select id="q5" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        6. How often in the last year did you need a drink in the morning after heavy drinking? *
        <select id="q6" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        7. How often in the last year have you felt guilt or remorse after drinking? *
        <select id="q7" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        8. How often in the last year were you unable to remember what happened the night before? *
        <select id="q8" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">Never (0)</option>
          <option value="1">Less than monthly (1)</option>
          <option value="2">Monthly (2)</option>
          <option value="3">Weekly (3)</option>
          <option value="4">Daily or almost daily (4)</option>
        </select>
      </label>
      <label>
        9. Have you or someone else been injured due to your drinking? *
        <select id="q9" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">No (0)</option>
          <option value="2">Yes, but not in last year (2)</option>
          <option value="4">Yes, during the last year (4)</option>
        </select>
      </label>
      <label>
        10. Has a relative, friend, doctor, or health worker been concerned or suggested you cut down? *
        <select id="q10" required>
          <option value="" disabled selected>Choose...</option>
          <option value="0">No (0)</option>
          <option value="2">Yes, but not in last year (2)</option>
          <option value="4">Yes, during the last year (4)</option>
        </select>
      </label>

      <button type="button" onclick="calculateAuditScore()">Calculate Total Audit Score</button>
      <div id="totalAuditScore" class="score-output">Total Audit Score: —</div>
      <div id="riskSeverity" class="result"></div>

      <!-- New: Save to EHR button (disabled until SMART auth ready) -->
      <button id="saveToEHRBtn" type="button" onclick="saveToEHR()" disabled>Save answers to EHR (QuestionnaireResponse)</button>
    </div>
  </form>

  <script>
    // --- Your existing functions (kept mostly unchanged) ---
    function calculateFastC() {
      const gender = document.getElementById('gender').value;
      const q1 = parseInt(document.getElementById('q1').value || 0);
      const q2 = parseInt(document.getElementById('q2').value || 0);
      const q3 = parseInt(document.getElementById('q3').value || 0);

      if (!gender || isNaN(q1) || isNaN(q2) || isNaN(q3)) {
        alert("Please answer gender and all questions in Section 1.");
        return;
      }

      const fastCScore = q1 + q2 + q3;
      document.getElementById('fastCScore').textContent = `FAST C Score: ${fastCScore}`;

      const section2 = document.getElementById('section2');
      const selects = section2.querySelectorAll('select');

      // Define threshold by gender
      const threshold = (gender === 'female') ? 3 : 4;

      if (fastCScore >= threshold) {
        section2.classList.remove('disabled-section');
        selects.forEach(select => select.disabled = false);
      } else {
        section2.classList.add('disabled-section');
        selects.forEach(select => select.disabled = true);
        document.getElementById('totalAuditScore').textContent = "Total Audit Score: —";
        const riskSeverity = document.getElementById('riskSeverity');
        riskSeverity.textContent = "";
        riskSeverity.className = "result";
        selects.forEach(select => {
          select.disabled = true;
          select.selectedIndex = 0; // Resets to "Choose..." option
        });
      }
    }

    function calculateAuditScore() {
      const questionIds = ['q1','q2','q3','q4','q5','q6','q7','q8','q9','q10'];
      let totalScore = 0;

      for (let id of questionIds) {
        const value = parseInt(document.getElementById(id).value);
        if (isNaN(value)) {
          alert("Please answer all questions before calculating the score.");
          return;
        }
        totalScore += value;
      }

      document.getElementById('totalAuditScore').textContent = `Total Audit Score: ${totalScore}`;

      const riskSeverity = document.getElementById('riskSeverity');
      riskSeverity.className = "result";

      if (totalScore <= 7) {
        riskSeverity.textContent = "Risk Level: Low Risk";
        riskSeverity.classList.add("risk-low");
      } else if (totalScore >= 8 && totalScore <= 15) {
        riskSeverity.textContent = "Risk Level: Increasing Risk";
        riskSeverity.classList.add("risk-increasing");
      } else if (totalScore >= 16 && totalScore <= 19) {
        riskSeverity.textContent = "Risk Level: Higher Risk";
        riskSeverity.classList.add("risk-higher");
      } else if (totalScore >= 20) {
        riskSeverity.textContent = "Risk Level: Possible Dependence";
        riskSeverity.classList.add("risk-dependence");
      }
    }

    
<script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

<div id="contextBanner" style="background:#f0f0f0;padding:8px;margin-bottom:15px;border-radius:5px;">
  Loading patient and user info...
</div>

<script>
  window.smartClient = null;

  FHIR.oauth2.ready().then(async client => {
    window.smartClient = client;
    console.log("SMART client ready", client);

    let banner = "";

    // --- Patient info ---
    if (client.patient && client.patient.id) {
      try {
        const patient = await client.patient.read();
        const name = patient.name?.[0]
          ? ((patient.name[0].given || []).join(" ") + " " + (patient.name[0].family || ""))
          : "Unknown";
        const gender = patient.gender || "Unknown";
        const dob = patient.birthDate || "Unknown";
        banner += `<b>Patient:</b> ${name} | <b>Gender:</b> ${gender} | <b>DOB:</b> ${dob}`;
        document.getElementById("saveToEHRBtn").disabled = false;
      } catch (e) {
        console.error("Patient read failed", e);
        banner += "<b>Patient:</b> Unknown";
      }
    } else {
      banner += "No patient context.";
    }

    // --- User (provider) info ---
    try {
      const user = await client.user.read();
      const username = user.name?.[0]
        ? ((user.name[0].given?.[0] || "") + " " + (user.name[0].family || ""))
        : (user.id || "Unknown");
      banner += `<br><b>User:</b> ${username} (${user.resourceType})`;
    } catch (e) {
      console.warn("User read failed", e);
      banner += "<br><b>User:</b> Unknown";
    }

    document.getElementById("contextBanner").innerHTML = banner;
  }).catch(err => {
    console.error("SMART ready() failed", err);
    document.getElementById("contextBanner").innerHTML = "SMART launch failed.";
  });
</script>

<script>
async function saveToEHR() {
  if (!window.smartClient) {
    alert("App not authorized. Launch this app from an EHR (or use the SMART sandbox).");
    return;
  }
  const client = window.smartClient;

  if (!client.patient || !client.patient.id) {
    alert("No patient context available. App must be launched from EHR with a patient selected.");
    return;
  }

  // gather answers
  const qIds = ['q1','q2','q3','q4','q5','q6','q7','q8','q9','q10'];
  const items = [];
  let totalScore = 0;
  for (let i=0;i<qIds.length;i++) {
    const el = document.getElementById(qIds[i]);
    if (!el || el.value === "" ) {
      alert("Please answer all questions before saving.");
      return;
    }
    const val = parseInt(el.value);
    totalScore += val;
    items.push({
      linkId: (i+1).toString(),
      text: el.parentElement.innerText.split('\n')[0] || `Q${i+1}`,
      answer: [{ valueInteger: val }]
    });
  }

  // Compute AUDIT-C score (Q1–Q3)
  const q1 = parseInt(document.getElementById('q1').value);
  const q2 = parseInt(document.getElementById('q2').value);
  const q3 = parseInt(document.getElementById('q3').value);
  const auditCScore = q1 + q2 + q3;

  // Build QuestionnaireResponse
  const qr = {
    resourceType: "QuestionnaireResponse",
    questionnaire: "http://loinc.org/72109-2", // AUDIT 10-item panel
    status: "completed",
    subject: { reference: `Patient/${client.patient.id}` },
    authored: new Date().toISOString(),
    item: items
  };

  try {
    const createdQR = await client.create(qr);
    console.log("Created QuestionnaireResponse:", createdQR);

    // --- Observation: AUDIT Total Score (Q1–Q10) ---
    const obsAuditTotal = {
      resourceType: "Observation",
      status: "final",
      category: [{
        coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "survey" }]
      }],
      code: {
        coding: [{
          system: "http://loinc.org",
          code: "72109-2",
          display: "Alcohol Use Disorders Identification Test [AUDIT]"
        }],
        text: "AUDIT Total Score"
      },
      subject: { reference: `Patient/${client.patient.id}` },
      effectiveDateTime: new Date().toISOString(),
      valueInteger: totalScore,
      derivedFrom: [{ reference: `QuestionnaireResponse/${createdQR.id}` }]
    };

    const createdObsAuditTotal = await client.create(obsAuditTotal);

    // --- Observation: AUDIT-C Score (Q1–Q3) ---
    const obsAuditC = {
      resourceType: "Observation",
      status: "final",
      category: [{
        coding: [{ system: "http://terminology.hl7.org/CodeSystem/observation-category", code: "survey" }]
      }],
      code: {
        coding: [{
          system: "http://loinc.org",
          code: "75626-2",
          display: "Alcohol Use Disorders Identification Test consumption score [AUDIT-C]"
        }],
        text: "AUDIT-C Score"
      },
      subject: { reference: `Patient/${client.patient.id}` },
      effectiveDateTime: new Date().toISOString(),
      valueInteger: auditCScore,
      derivedFrom: [{ reference: `QuestionnaireResponse/${createdQR.id}` }]
    };

    const createdObsAuditC = await client.create(obsAuditC);

    alert(`Saved to EHR:
- QuestionnaireResponse id: ${createdQR.id}
- Observation (AUDIT total, 72109-2) id: ${createdObsAuditTotal.id}, score = ${totalScore}
- Observation (AUDIT-C, 75626-2) id: ${createdObsAuditC.id}, score = ${auditCScore}`);

    console.log("Created Observations:", { auditTotal: createdObsAuditTotal, auditC: createdObsAuditC });

  } catch (err) {
    console.error("Failed to save resources:", err);
    alert("Save to EHR failed (see console). Server may disallow writes or CORS/permissions issue.");
  }
}
  </script>
</body>
</html>

